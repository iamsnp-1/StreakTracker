<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Levi's Log: Precision Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Montserrat:wght@400;600;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --corps-green: #0a1f12; --corps-accent: #1e5a32; --steel: #b8c2cc; --gold: #c5a059;
            --gas-blue: #00d2ff; --bg-dark: #050505;
            --rage-1: #8a0b0b; --rage-2: #ff0000; --rage-3: #ff4500;
            --box-size: 50px; --font-size: 1rem; --grid-gap: 4px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Montserrat', sans-serif; background-color: var(--bg-dark);
            height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center;
            overflow: hidden; background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            background-size: cover; background-position: center;
            color: var(--steel); position: relative; transition: all 0.5s ease-out;
            overscroll-behavior: none;
        }

        /* --- FX LAYERS --- */
        .rage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 0%, #000 100%);
            mix-blend-mode: multiply; pointer-events: none; z-index: 1; opacity: 0; transition: opacity 1s;
        }
        .fog-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.4; pointer-events: none; z-index: 2;
        }
        .lightning-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.2); z-index: 100; pointer-events: none; opacity: 0; mix-blend-mode: overlay;
        }
        .lightning-flash { animation: flash 0.1s linear; }
        .flare-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; pointer-events: none; opacity: 0;
            transition: opacity 0.5s ease-out; mix-blend-mode: screen;
        }
        .flare-active { opacity: 0.8; }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        /* --- RAGE TIERS --- */
        body.rage-anger .rage-overlay { background: radial-gradient(circle at center, rgba(138, 11, 11, 0.2) 0%, rgba(0,0,0,0.9) 100%); opacity: 1; }
        body.rage-anger .container { border-color: var(--rage-1); box-shadow: 0 0 60px rgba(138, 11, 11, 0.4); }
        
        body.rage-fury .rage-overlay { background: radial-gradient(circle at center, rgba(255, 0, 0, 0.3) 0%, #000 100%); opacity: 1; }
        body.rage-fury .container { border-color: var(--rage-2); box-shadow: 0 0 80px rgba(255, 0, 0, 0.6); animation: pulseFury 0.8s infinite; }
        @keyframes pulseFury { 0% { transform: scale(1); } 50% { transform: scale(1.005); border-color: #ff5555; } 100% { transform: scale(1); } }

        body.rage-berserk .rage-overlay { background: radial-gradient(circle at center, rgba(255, 69, 0, 0.2) 0%, #000 100%); opacity: 1; mix-blend-mode: hard-light; }
        body.rage-berserk .container { border-color: var(--rage-3); box-shadow: 0 0 100px rgba(255, 69, 0, 0.8); animation: glitchShake 0.2s infinite; }
        body.rage-berserk .streak-val { color: var(--rage-3); text-shadow: 0 0 20px var(--rage-3); animation: glitchText 0.3s infinite; display: inline-block; }
        
        @keyframes glitchShake { 0% { transform: translate(1px, 1px); } 25% { transform: translate(-1px, -1px); } 50% { transform: translate(-1px, 1px); } 75% { transform: translate(1px, -1px); } 100% { transform: translate(0, 0); } }
        @keyframes glitchText { 0% { opacity: 1; } 50% { opacity: 0.8; transform: skewX(10deg); } 100% { opacity: 1; transform: skewX(0deg); } }

        /* --- UI COMPONENTS --- */
        .container {
            background: rgba(20, 25, 20, 0.95); width: 96vw; height: 96vh;
            border: 1px solid rgba(255,255,255,0.1); border-top: 4px solid var(--corps-accent); border-bottom: 4px solid var(--corps-accent);
            border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            position: relative; display: flex; flex-direction: column; backdrop-filter: blur(2px); z-index: 10;
            transition: border-color 0.5s, box-shadow 0.5s;
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); flex-shrink: 0; height: 80px;
        }
        .title-group h1 { font-family: 'Cinzel', serif; font-size: 1.6rem; color: var(--steel); margin: 0; line-height: 1; }
        .title-group span { font-size: 0.65rem; color: var(--gold); letter-spacing: 2px; text-transform: uppercase; }
        .stats-group { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
        .streak-wrapper { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 0.7rem; color: #555; letter-spacing: 1px; }
        .streak-val { font-size: 1.1rem; color: #fff; margin-left: 5px; transition: transform 0.2s; }

        .btn-group { display: flex; gap: 5px; margin-top: 2px; }
        .header-btn {
            font-size: 0.6rem; color: #5c2b2b; border: 1px solid #5c2b2b; padding: 2px 8px;
            text-transform: uppercase; letter-spacing: 1px; border-radius: 2px;
            transition: all 0.3s; cursor: pointer; opacity: 0.7; background: transparent;
        }
        .header-btn:hover { opacity: 1; background: var(--blood); color: white; border-color: var(--blood); }
        .header-btn.bg-btn { color: var(--gold); border-color: var(--gold); }
        .header-btn.bg-btn:hover { background: var(--gold); color: black; }
        .header-btn.flare-btn { color: #0f0; border-color: #0f0; text-shadow: 0 0 5px #0f0; }
        .header-btn.flare-btn:hover { background: #0f0; color: #000; }

        /* --- SQUAD LIST --- */
        .info-panel { padding: 5px 20px 10px; position: relative; flex-shrink: 0; display:flex; gap: 15px; align-items: flex-start; }
        .main-gauge-wrapper { flex: 2; }
        .gas-bar-container { width: 100%; height: 20px; background: #0a0a0a; border: 1px solid #333; border-radius: 4px; position: relative; overflow: hidden; margin-top: 2px; }
        .gas-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #005c7a, var(--gas-blue)); box-shadow: 0 0 20px var(--gas-blue); position: absolute; z-index: 2; transition: width 0.3s cubic-bezier(0.22, 1, 0.36, 1); opacity: 0.9; }
        
        .squad-list-wrapper { flex: 1; max-height: 80px; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 5px; border-radius: 4px; }
        .squad-list-wrapper::-webkit-scrollbar { width: 3px; }
        .squad-list-wrapper::-webkit-scrollbar-thumb { background: #444; }
        .squad-member { display: flex; align-items: center; gap: 5px; font-size: 0.6rem; margin-bottom: 3px; }
        .squad-name { width: 50px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #888; }
        .squad-bar-bg { flex: 1; height: 5px; background: #111; border-radius: 2px; overflow: hidden; }
        .squad-bar-fill { height: 100%; background: #5c2b2b; width: 0%; transition: width 0.5s; }

        /* --- GRID --- */
        .content-area { flex: 1; padding: 10px; display: flex; flex-direction: column; overflow: hidden; position: relative; align-items: center; justify-content: center; }
        .grid-container { display: flex; flex-wrap: wrap; justify-content: center; align-content: center; gap: var(--grid-gap); width: 100%; height: 100%; }
        .titan-box {
            width: var(--box-size); height: var(--box-size);
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.3); font-family: 'Cinzel', serif; font-weight: bold; font-size: var(--font-size);
            cursor: pointer; transition: transform 0.1s; flex-shrink: 0; position: relative;
        }
        .titan-box:hover { background: rgba(255,255,255,0.1); border-color: var(--steel); color: #fff; transform: scale(1.1); z-index: 5; }
        .titan-box.killed { background: transparent; border: 1px dashed rgba(255,255,255,0.1); color: transparent; pointer-events: auto; }
        .titan-box.killed::before { content: ''; position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, transparent 70%); animation: steam 1s forwards; pointer-events: none; }
        .has-note::after { content: 'âœŽ'; position: absolute; top:2px; right:2px; font-size: 0.6rem; color: var(--gold); opacity: 0.8; }
        @keyframes steam { to { opacity: 0; transform: scale(1.5) translateY(-20px); } }

        /* --- DIAL --- */
        #setupView { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dial-container { 
            width: 260px; height: 260px; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; user-select: none;
            touch-action: none;
        }
        .dial-ring-outer { position: absolute; width: 100%; height: 100%; border: 2px dashed rgba(197, 160, 89, 0.3); border-radius: 50%; animation: spin 20s linear infinite; }
        .dial-ring-inner { position: absolute; width: 85%; height: 85%; border: 1px solid rgba(184, 194, 204, 0.2); border-top: 1px solid var(--gas-blue); border-radius: 50%; animation: spinRev 10s linear infinite; }
        .dial-svg { width: 100%; height: 100%; transform: rotate(-90deg); pointer-events: none; position: relative; z-index: 5; }
        .dial-track { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 8; }
        .dial-progress { fill: none; stroke: var(--gold); stroke-width: 8; stroke-dasharray: 660; stroke-dashoffset: 660; transition: stroke-dashoffset 0.1s; stroke-linecap: round; filter: drop-shadow(0 0 5px var(--gold)); }
        .dial-interaction-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 20; cursor: grab; border-radius: 50%; touch-action: none; }
        .knob-dot { position: absolute; top: 15px; left: 50%; width: 30px; height: 30px; background: #fff; border: 2px solid var(--gold); border-radius: 50%; transform: translate(-50%, 0); box-shadow: 0 0 15px var(--gold); pointer-events: none; transition: transform 0.1s; z-index: 6; }
        .dial-center { position: absolute; z-index: 2; text-align: center; pointer-events: none; }
        .dial-input { pointer-events: all; background: transparent; border: none; font-family: 'Cinzel', serif; font-size: 3.5rem; color: var(--steel); text-align: center; width: 150px; text-shadow: 0 0 20px rgba(0, 210, 255, 0.5); outline: none; }
        .dial-label { display: block; font-size: 0.7rem; color: var(--gas-blue); letter-spacing: 3px; font-weight: bold; margin-top: -10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spinRev { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
        .btn-initiate { background: transparent; color: var(--gold); border: 2px solid var(--gold); padding: 12px 50px; font-family: 'Cinzel', serif; font-size: 1.1rem; cursor: pointer; transition: 0.3s; letter-spacing: 2px; text-transform: uppercase; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); margin-top: 20px; }
        .btn-initiate:hover { background: var(--gold); color: #000; box-shadow: 0 0 30px var(--gold); }

        /* --- MODALS --- */
        .status-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            font-family: 'Cinzel', serif; font-weight: 900; font-size: 3rem; color: #fff;
            text-shadow: 0 0 20px var(--rage-2), 0 0 50px var(--rage-2); opacity: 0; pointer-events: none; z-index: 100; white-space: nowrap;
        }
        .status-msg.pop { animation: msgPop 1.5s forwards; }
        @keyframes msgPop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 10% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(2); filter: blur(10px); } }

        .crit-text { position: absolute; color: var(--rage-2); font-family: 'Cinzel', serif; font-weight: 900; font-size: 1.5rem; text-shadow: 0 0 5px #fff; pointer-events: none; z-index: 50; animation: critPop 0.5s forwards; white-space: nowrap; }
        @keyframes critPop { 0% { transform: scale(0.5) rotate(-10deg); opacity: 0; } 50% { transform: scale(1.5) rotate(-10deg); opacity: 1; } 100% { transform: scale(1) rotate(-10deg) translateY(-20px); opacity: 0; } }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #050505; z-index: 200; display:flex; justify-content:center; align-items:center; }
        .modal-box { text-align: center; border: 1px solid #444; padding: 20px; width: 90%; max-width: 400px; background: #111; }
        .modal-input { padding: 15px; font-size: 1.2rem; background: #111; border: 2px solid #333; color: white; text-align: center; width: 90%; margin-top: 10px; display: block; margin-left: auto; margin-right: auto; }
        .modal-btn { padding: 15px 30px; font-size: 1rem; background: var(--gold); border: none; font-weight: bold; cursor: pointer; margin-top: 20px; font-family: 'Cinzel'; margin-left: 5px; }
        textarea.modal-input { min-height: 100px; text-align: left; resize: none; font-family: monospace; font-size: 1rem; }

        .hidden { display: none !important; }
    </style>
</head>
<body id="appBody">

<div class="rage-overlay"></div>
<div class="fog-layer"></div>
<div class="lightning-overlay" id="lightning"></div>
<div class="flare-overlay" id="flareOverlay"></div>
<div class="status-msg" id="statusMsg">RAMPAGE</div>

<div class="modal-overlay" id="lobbyModal">
    <div class="modal-box">
        <h1 style="font-family:'Cinzel'; color:var(--steel); font-size: 2.5rem;">SQUAD JOIN</h1>
        <p style="color:#888; margin-top: 20px;">CALL SIGN</p>
        <input type="text" id="nameInput" class="modal-input" placeholder="e.g. Captain Levi">
        <p style="color:#888; margin-top: 15px;">ROOM NAME</p>
        <input type="text" id="roomInput" class="modal-input" placeholder="e.g. wall-maria">
        <button class="modal-btn" onclick="joinRoom()">DEPLOY</button>
    </div>
</div>

<div class="modal-overlay hidden" id="noteModal">
    <div class="modal-box">
        <h2 style="font-family:'Cinzel'; color:var(--gold);">FIELD REPORT</h2>
        <textarea id="noteInput" class="modal-input" placeholder="Log details here..."></textarea>
        <div>
            <button class="modal-btn" onclick="saveNote()">SAVE</button>
            <button class="modal-btn" style="background:#5c2b2b; color:#fff;" onclick="reviveTitan()">REVIVE</button>
            <button class="modal-btn" style="background:#333; color:#fff;" onclick="closeNote()">CANCEL</button>
        </div>
    </div>
</div>

<div class="container hidden" id="gameContainer">
    <header>
        <div class="title-group">
            <span>Survey Corps</span>
            <h1>Expedition</h1>
        </div>
        <div class="stats-group">
            <div class="streak-wrapper">
                <span id="roomDisplay" style="color:var(--gas-blue)"></span> | STREAK <span class="streak-val" id="streakVal">0</span>
            </div>
            <div class="btn-group">
                <button class="header-btn flare-btn" onclick="fireFlare('green')" title="Signal Flare">FLARE</button>
                <input type="file" id="bgInput" accept="image/*" style="display:none">
                <button class="header-btn bg-btn" onclick="document.getElementById('bgInput').click()">BG</button>
                <button class="header-btn" onclick="resetAll()">Abort</button>
            </div>
        </div>
    </header>

    <div class="info-panel">
        <div class="main-gauge-wrapper">
            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--gas-blue); margin-bottom: 2px;">
                <span>GAS LEVELS</span>
                <span style="font-weight: bold;">YOU: <span id="myPct">0%</span></span>
            </div>
            <div class="gas-bar-container">
                <div class="gas-fill" id="gasFill"></div>
            </div>
        </div>
        <div class="squad-list-wrapper" id="squadList">
            <div style="font-size:0.6rem; color:#555; text-align:center;">WAITING FOR SQUAD...</div>
        </div>
    </div>

    <div class="content-area" id="mainArea">
        <div id="setupView">
            <div class="dial-container" id="dialContainer">
                <div class="dial-ring-outer"></div> <div class="dial-ring-inner"></div>
                <svg class="dial-svg" viewBox="0 0 260 260">
                    <circle class="dial-track" cx="130" cy="130" r="105" />
                    <circle class="dial-progress" id="dialProgress" cx="130" cy="130" r="105" />
                </svg>
                <div class="dial-interaction-layer" id="dialInteraction"></div>
                <div class="knob-dot" id="knobDot"></div>
                <div class="dial-center">
                    <input type="number" id="dialInput" class="dial-input" value="30" min="1" max="365">
                    <span class="dial-label">DAYS</span>
                </div>
            </div>
            <button class="btn-initiate" onclick="startMission()">INITIATE</button>
        </div>

        <div id="gridView" class="grid-container hidden"></div>
    </div>
</div>

<script>
    // ------------------------------------------------------------------
    // PASTE FIREBASE CONFIG HERE
    // ------------------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyBhgKU1kSCJhzsFABa-IXRe19BaxTSQACI",
  authDomain: "tracker-9f72a.firebaseapp.com",
  databaseURL: "https://tracker-9f72a-default-rtdb.firebaseio.com",
  projectId: "tracker-9f72a",
  storageBucket: "tracker-9f72a.firebasestorage.app",
  messagingSenderId: "1037638988632",
  appId: "1:1037638988632:web:dd2356fa86c33a494beb2d",
  measurementId: "G-VLLG075RMR"
};
    // ------------------------------------------------------------------

    let db = null;
    try {
        if(firebaseConfig.apiKey) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        }
    } catch(e) { console.warn("Firebase Error"); }

    const KEY = 'levi_precision_log';
    const BG_KEY = 'levi_precision_bg';
    const ROOM_KEY = 'levi_room_id';
    const ID_KEY = 'levi_player_id';
    
    // Persistent ID Logic
    let myId = localStorage.getItem(ID_KEY);
    if (!myId) {
        myId = 'scout_' + Math.random().toString(36).substr(2, 6);
        localStorage.setItem(ID_KEY, myId);
    }

    let myName = "Scout";
    let roomId = null;
    let data = { active: false, total: 0, titans: [], streak: 0, lastLogDate: null, dailyKills: 0 };
    let squadData = {}; 
    let selectedTitanIndex = null;

    // --- SOUND ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'slash') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'click') {
            osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        } else if (type === 'flare') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.0);
            osc.start(); osc.stop(audioCtx.currentTime + 1.0);
        }
    }

    // --- DOM ---
    const els = {
        lobby: document.getElementById('lobbyModal'),
        game: document.getElementById('gameContainer'),
        roomInput: document.getElementById('roomInput'),
        nameInput: document.getElementById('nameInput'),
        roomDisplay: document.getElementById('roomDisplay'),
        setup: document.getElementById('setupView'),
        grid: document.getElementById('gridView'),
        gasFill: document.getElementById('gasFill'),
        myPct: document.getElementById('myPct'),
        squadList: document.getElementById('squadList'),
        streakVal: document.getElementById('streakVal'),
        statusMsg: document.getElementById('statusMsg'),
        mainArea: document.getElementById('mainArea'),
        body: document.getElementById('appBody'),
        bgInput: document.getElementById('bgInput'),
        lightning: document.getElementById('lightning'),
        flareOverlay: document.getElementById('flareOverlay'),
        noteModal: document.getElementById('noteModal'),
        noteInput: document.getElementById('noteInput')
    };

    // --- TIME UTILS (LOCAL) ---
    function getTodayString() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // --- DIAL ---
    const dialInteraction = document.getElementById('dialInteraction');
    const dialProgress = document.getElementById('dialProgress');
    const knobDot = document.getElementById('knobDot');
    const dialInput = document.getElementById('dialInput');
    const dialContainer = document.getElementById('dialContainer');
    let isDragging = false; const radius = 105; const circumference = 2 * Math.PI * radius;

    function setDialValue(days) {
        let displayDays = days; if(days > 90) displayDays = days % 90 || 90;
        const degrees = (displayDays / 90) * 360;
        const offset = circumference - (degrees / 360) * circumference;
        dialProgress.style.strokeDasharray = circumference; dialProgress.style.strokeDashoffset = offset;
        const rad = (degrees - 90) * (Math.PI / 180);
        const x = 130 + (radius * Math.cos(rad)); const y = 130 + (radius * Math.sin(rad));
        knobDot.style.transform = `translate(${x - 130 - 15}px, ${y - 130 - 15}px)`;
        dialInput.value = days;
    }
    function handleDrag(e) {
        if(e.type === 'touchmove') e.preventDefault();
        const rect = dialContainer.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX; 
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        let angle = Math.atan2(clientY - centerY, clientX - centerX) * (180 / Math.PI); 
        angle = angle + 90; if(angle < 0) angle += 360;
        let days = Math.round((angle / 360) * 90); if(days <= 0) days = 1; setDialValue(days);
    }
    dialInteraction.addEventListener('mousedown', () => isDragging = true);
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('mousemove', (e) => { if(isDragging) handleDrag(e); });
    dialInteraction.addEventListener('touchstart', (e) => { isDragging = true; handleDrag(e); }, { passive: false });
    window.addEventListener('touchend', () => isDragging = false);
    window.addEventListener('touchmove', (e) => { if(isDragging) handleDrag(e); }, { passive: false });
    dialInput.addEventListener('change', (e) => setDialValue(parseInt(e.target.value)||30));
    setDialValue(30);

    // --- SETUP ---
    window.onload = () => {
        // Init Check
        checkRealTimeDecay();
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) checkRealTimeDecay();
        });

        const saved = localStorage.getItem(KEY);
        if(saved) {
            data = JSON.parse(saved);
        }
        
        const savedBg = localStorage.getItem(BG_KEY);
        if(savedBg) els.body.style.backgroundImage = `url('${savedBg}')`;
        els.bgInput.addEventListener('change', handleBgUpload);
        window.addEventListener('resize', () => { if(data.active) calcLayout(); });

        const savedRoom = localStorage.getItem(ROOM_KEY);
        const savedName = localStorage.getItem(ROOM_KEY + '_name');
        if(savedRoom && savedName) {
            els.roomInput.value = savedRoom; els.nameInput.value = savedName;
            joinRoom(); 
        }
    };

    function handleBgUpload(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onloadend = function() {
            els.body.style.backgroundImage = `url('${reader.result}')`;
            try { localStorage.setItem(BG_KEY, reader.result); } catch(e){}
        }
        reader.readAsDataURL(file);
    }

    // --- JOIN ---
    function joinRoom() {
        if(!db) { alert("Paste Firebase Config in the code to enable multiplayer!"); return; }
        const rName = els.roomInput.value.trim();
        const pName = els.nameInput.value.trim();
        if(!rName || !pName) return alert("Required");
        
        roomId = rName.toLowerCase().replace(/[^a-z0-9]/g, '-');
        myName = pName;

        localStorage.setItem(ROOM_KEY, roomId);
        localStorage.setItem(ROOM_KEY + '_name', myName);

        els.lobby.classList.add('hidden');
        els.game.classList.remove('hidden');
        els.roomDisplay.innerText = roomId.toUpperCase();

        listenToRoom(); 
        if(data.active) { renderGame(); updateServer(); }
    }

    // --- GAME ---
    function startMission() {
        const val = parseInt(dialInput.value); if(!val) return;
        const newTitans = []; for(let i=0; i<val; i++) newTitans.push({ id: i+1, dead: false, note: "" });
        data.active = true; data.total = val; data.titans = newTitans;
        save(); renderGame(); updateServer();
    }

    function renderGame() {
        els.setup.classList.add('hidden'); els.grid.classList.remove('hidden'); els.grid.innerHTML = '';
        data.titans.forEach((t, i) => {
            const box = document.createElement('div');
            box.className = `titan-box ${t.dead ? 'killed' : ''} ${t.note ? 'has-note' : ''}`;
            if(!t.dead) box.innerText = i + 1;
            box.onclick = () => handleBoxClick(i, box);
            els.grid.appendChild(box);
        });
        calcLayout(); updateUI(); checkRageMode();
    }

    function handleBoxClick(index, box) {
        if(data.titans[index].dead) openNote(index);
        else killTitan(index, box);
    }

    function openNote(index) {
        selectedTitanIndex = index;
        els.noteInput.value = data.titans[index].note || "";
        els.noteModal.classList.remove('hidden');
        playSound('click');
    }

    function saveNote() {
        if(selectedTitanIndex === null) return;
        data.titans[selectedTitanIndex].note = els.noteInput.value;
        save(); renderGame(); closeNote();
    }

    function reviveTitan() {
        if(selectedTitanIndex === null) return;
        data.titans[selectedTitanIndex].dead = false;
        data.titans[selectedTitanIndex].note = "";
        save(); renderGame(); updateServer(); closeNote();
    }

    function closeNote() { els.noteModal.classList.add('hidden'); selectedTitanIndex = null; }

    // --- STREAK LOGIC ---
    function checkRealTimeDecay() {
        // Runs on load and on visibility change
        const saved = localStorage.getItem(KEY);
        if(!saved) return;
        
        let tempData = JSON.parse(saved);
        if(!tempData.lastLogDate) return;

        const todayStr = getTodayString();
        if(tempData.lastLogDate !== todayStr) {
            // New day detected. Reset daily kills immediately.
            tempData.dailyKills = 0;
            
            // Check if streak broke
            const last = new Date(tempData.lastLogDate);
            const today = new Date(todayStr);
            const diffDays = Math.floor((today - last) / (1000 * 60 * 60 * 24));
            
            if (diffDays > 1) {
                tempData.streak = 0; // Reset streak if gap > 1 day
            }
            
            data = tempData;
            save();
            if(data.active) { updateUI(); checkRageMode(); }
        }
    }

    function killTitan(index, box) {
        data.titans[index].dead = true;
        const todayStr = getTodayString();
        
        // Accurate Streak Calculation
        if(data.lastLogDate === todayStr) { 
            data.dailyKills = (data.dailyKills||0) + 1; 
        } else {
            // It's a new day (that wasn't caught by checkRealTimeDecay yet)
            data.dailyKills = 1;
            const last = data.lastLogDate ? new Date(data.lastLogDate) : null;
            const today = new Date(todayStr);
            
            if (last) {
                const diffDays = Math.floor((today - last) / (1000 * 60 * 60 * 24));
                if (diffDays === 1) data.streak++; // Consecutive
                else data.streak = 1; // Gap or new
            } else {
                data.streak = 1;
            }
            data.lastLogDate = todayStr;
        }
        
        save(); playSound('slash');
        
        if(Math.random() > 0.9) {
            const crit = document.createElement('div'); crit.className = 'crit-text'; crit.innerText = "PERFECT CUT";
            crit.style.left = (box.getBoundingClientRect().left) + 'px'; 
            crit.style.top = (box.getBoundingClientRect().top) + 'px';
            document.body.appendChild(crit); setTimeout(()=>crit.remove(), 600);
        }

        checkRageMode(); renderGame(); updateServer();
    }

    function checkRageMode() {
        els.body.classList.remove('rage-anger', 'rage-fury', 'rage-berserk');
        let effectiveStreak = data.streak;
        if(data.dailyKills >= 2 && effectiveStreak < 3) effectiveStreak = 3;
        if(data.dailyKills >= 5 && effectiveStreak < 5) effectiveStreak = 5;

        if(effectiveStreak >= 10) { els.body.classList.add('rage-berserk'); triggerLightning(); if(data.dailyKills>=2) showStatus("GOD MODE"); }
        else if (effectiveStreak >= 5) els.body.classList.add('rage-fury');
        else if (effectiveStreak >= 3) els.body.classList.add('rage-anger');
    }

    function triggerLightning() {
        els.lightning.classList.remove('lightning-flash');
        void els.lightning.offsetWidth; els.lightning.classList.add('lightning-flash');
    }

    function fireFlare(type) {
        if(!db || !roomId) return;
        showFlare(type === 'green' ? '#0f0' : '#f00');
        db.ref('rooms/' + roomId + '/flare').set({ color: type, sender: myName, timestamp: Date.now() });
    }

    function showFlare(color) {
        els.flareOverlay.style.backgroundColor = color;
        els.flareOverlay.classList.add('flare-active');
        playSound('flare');
        showStatus("SIGNAL FLARE RECEIVED");
        setTimeout(() => els.flareOverlay.classList.remove('flare-active'), 1000);
    }

    function showStatus(msg) {
        els.statusMsg.innerText = msg; els.statusMsg.classList.remove('pop');
        void els.statusMsg.offsetWidth; els.statusMsg.classList.add('pop');
    }

    function updateUI() {
        const kills = data.titans.filter(t => t.dead).length;
        const pct = data.total > 0 ? Math.round((kills / data.total) * 100) : 0;
        els.gasFill.style.width = pct + '%';
        els.myPct.innerText = pct + '%';
        els.streakVal.innerText = data.streak;

        if(els.body.classList.contains('rage-berserk')) els.gasFill.style.background = 'linear-gradient(90deg, #ff4500, #ff8c00)';
        else if(els.body.classList.contains('rage-fury')) els.gasFill.style.background = 'linear-gradient(90deg, #ff0000, #ff5555)';
        else if(els.body.classList.contains('rage-anger')) els.gasFill.style.background = 'linear-gradient(90deg, #8a0b0b, #b30000)';
        else els.gasFill.style.background = 'linear-gradient(90deg, #005c7a, #00d2ff)';
        
        renderSquadList();
    }

    function updateServer() {
        if(!db || !roomId) return;
        const kills = data.titans.filter(t => t.dead).length;
        db.ref('rooms/' + roomId + '/' + myId).set({
            name: myName, total: data.total, kills: kills, streak: data.streak, timestamp: Date.now()
        });
    }

    function listenToRoom() {
        if(!db || !roomId) return;
        db.ref('rooms/' + roomId).on('value', (snapshot) => {
            const val = snapshot.val();
            if(!val) return;
            if(val.flare && val.flare.timestamp > Date.now() - 2000 && val.flare.sender !== myName) {
                showFlare(val.flare.color === 'green' ? '#0f0' : '#f00');
            }
            squadData = val; delete squadData.flare;
            updateUI();
        });
    }

    function renderSquadList() {
        if(!squadData) return;
        let html = '';
        Object.keys(squadData).forEach(key => {
            if(key === myId) return; 
            const p = squadData[key];
            const pPct = p.total > 0 ? Math.round((p.kills / p.total) * 100) : 0;
            let barColor = '#5c2b2b';
            if(p.streak >= 10) barColor = '#ff4500'; else if(p.streak >= 5) barColor = '#ff0000'; else if(p.streak >= 3) barColor = '#8a0b0b';

            html += `
                <div class="squad-member">
                    <div class="squad-name" title="${p.name}">${p.name}</div>
                    <div class="squad-bar-bg">
                        <div class="squad-bar-fill" style="width:${pPct}%; background:${barColor}"></div>
                    </div>
                    <div style="color:#aaa; width:25px; text-align:right;">${pPct}%</div>
                </div>
            `;
        });
        if(html === '') html = '<div style="font-size:0.6rem; color:#555; text-align:center;">WAITING FOR SQUAD...</div>';
        els.squadList.innerHTML = html;
    }

    function calcLayout() {
        const w = els.mainArea.clientWidth; const h = els.mainArea.clientHeight;
        const totalArea = w * h; const areaPerBox = totalArea / (data.total || 30);
        let side = Math.floor(Math.sqrt(areaPerBox)) - 6;
        if(side < 15) side = 15; if(side > 100) side = 100;
        let fSize = side / 2.5; if(side < 25) fSize = 0;
        document.documentElement.style.setProperty('--box-size', `${side}px`);
        document.documentElement.style.setProperty('--font-size', `${fSize}px`);
    }

    function resetAll() {
        if(confirm("Abort Mission? This removes you from the squad.")) { 
            if(db && roomId && myId) { db.ref('rooms/' + roomId + '/' + myId).remove(); }
            data.active = false; 
            localStorage.removeItem(ROOM_KEY); 
            localStorage.removeItem(ROOM_KEY + '_name');
            save(); location.reload(); 
        }
    }
    function save() { localStorage.setItem(KEY, JSON.stringify(data)); }

</script>
</body>

</html>
